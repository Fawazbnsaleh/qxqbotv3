"""
Fix Mislabeled Training Samples - Round 9
Final cleanup from comprehensive scan
"""
import json, os, shutil
from datetime import datetime
from collections import Counter

DATA_PATH = "al_rased/data/labeledSamples/training_data.json"
BACKUP_DIR = "al_rased/data/labeledSamples/backups"

FIXES = [
    # ========================================================
    # Ø§Ø­ØªÙŠØ§Ù„ Ø·Ø¨ÙŠ (Ø¹Ø±Ø¶) â†’ Ø·Ø¨ÙŠØ¹ÙŠ (student question about their sick leave)
    # ========================================================
    (1462, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø¬ÙŠØª Ù„Ø§Ø®ØªØ¨Ø§Ø±ÙŠ Ù…ØªØ£Ø®Ø± Ø¨Ø³Ø¨Ø¨ Ø§Ù†ÙŠ ØªØ¹Ø¨Ø§Ù† ÙˆÙ…Ø¹ÙŠ Ø³ÙƒÙ„ÙŠÙ = Ø³Ø¤Ø§Ù„ Ø·Ø§Ù„Ø¨ Ø¹Ù† Ø¹Ø°Ø±Ù‡"),

    # ========================================================
    # ØºÙŠØ± Ø£Ø®Ù„Ø§Ù‚ÙŠ (Ø¹Ø±Ø¶) â†’ Ø³Ø¨Ø§Ù…
    # ========================================================
    (1485, "Ø³Ø¨Ø§Ù…", ["Ø³Ø¨Ø§Ù…"],
     "Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ§Øª ÙˆÙ‚Ù†ÙˆØ§Øª Ø§Ù„Ù†Ø§Ø³ = Ø¨ÙŠØ¹ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ØªØ±ÙÙŠÙ‡"),
    (1515, "Ø³Ø¨Ø§Ù…", ["Ø³Ø¨Ø§Ù…"],
     "Ø§Ø¹ØªØ²Ù„ÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø¹ØªÙƒÙÙŠ Ù„Ù„Ø¹Ø¨Ø§Ø¯Ø© = Ø¥Ø¹Ù„Ø§Ù† Ø®Ø¯Ù…Ø© ØªÙ†Ø¸ÙŠÙ"),

    # ========================================================
    # ØªÙ‡ÙƒÙŠØ± (Ø¹Ø±Ø¶) â†’ ØªÙ‡ÙƒÙŠØ± (Ø·Ù„Ø¨) / Ø·Ø¨ÙŠØ¹ÙŠ
    # ========================================================
    (1540, "ØªÙ‡ÙƒÙŠØ± (Ø·Ù„Ø¨)", ["ØªÙ‡ÙƒÙŠØ± (Ø·Ù„Ø¨)"],
     "Ø§Ø­Ø¯ Ø¹Ù†Ø¯Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ù‡ Ù…Ù‡ÙƒØ±Ù‡ Ù„Ù„Ø§ÙŠÙÙˆÙ† = Ø·Ù„Ø¨ Ù‡Ø§Ùƒ ÙˆÙ„ÙŠØ³ Ø¹Ø±Ø¶"),
    (1550, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙƒØ°Ø§ ÙŠØ·Ù„Ø¹ Ù„ÙŠ Ù„Ù…Ø§ Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ = Ù…Ø´ÙƒÙ„Ø© Ø¯Ø®ÙˆÙ„"),
    (1554, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø£Ù†Ø§ Ù…Ø³ØªØ¬Ø¯Ù‡ Ù…Ùˆ Ø±Ø§Ø¶ÙŠ ÙŠÙØªØ­ Ù…Ø¹Ø§ÙŠ Ø£Ø­Ø· Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ = Ù…Ø´ÙƒÙ„Ø© ØªØ³Ø¬ÙŠÙ„"),

    # ========================================================
    # ØªÙ‡ÙƒÙŠØ± (Ø¹Ø±Ø¶) â†’ Ø³Ø¨Ø§Ù… (selling Gmail accounts)
    # ========================================================
    (1551, "Ø³Ø¨Ø§Ù…", ["Ø³Ø¨Ø§Ù…"],
     "Ø¹Ø§ÙˆØ² Ø§ÙŠÙ…ÙŠÙ„Ø§Øª Ø¬ÙŠÙ…ÙŠÙ„ Ø§Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ 15 Ø¬Ù†ÙŠÙ‡ = Ø¨ÙŠØ¹ Ø­Ø³Ø§Ø¨Ø§Øª"),

    # ========================================================
    # Ø§Ø­ØªÙŠØ§Ù„ Ù…Ø§Ù„ÙŠ (Ø¹Ø±Ø¶) â†’ Ø·Ø¨ÙŠØ¹ÙŠ (just a Binance referral link)
    # ========================================================
    (1600, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø±Ø§Ø¨Ø· Ø¨ÙŠÙ†Ø§Ù†Ø³ Ø±ÙŠÙÙŠØ±Ø§Ù„ ÙÙ‚Ø· = Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø·"),

    # ========================================================
    # ØºØ´ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ (Ø·Ù„Ø¨) â†’ Ø·Ø¨ÙŠØ¹ÙŠ (student questions, not cheating)
    # ========================================================
    (1604, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ØªÙƒÙÙˆÙ† Ù…Ø§ØªØ¹Ø±ÙÙˆÙ† Ø®ØµÙˆØµÙŠ ÙŠØ´Ø±Ø­ Ø£Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª = Ø·Ù„Ø¨ Ø¯Ø±ÙˆØ³ Ø®ØµÙˆØµÙŠØ©"),
    (1614, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ø­Ø¯ ÙŠØ¹Ø±Ù ÙŠØ³ÙˆÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø§Ù†Ø± ÙŠØ³Ø§Ø¹Ø¯Ù†ÙŠ = Ø³Ø¤Ø§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©"),
]


def main():
    print("=" * 60)
    print("ðŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª - Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ø³Ø¹Ø©")
    print("=" * 60)

    with open(DATA_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    print(f"ðŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª: {len(data)}")

    os.makedirs(BACKUP_DIR, exist_ok=True)
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = os.path.join(BACKUP_DIR, f"training_data_pre_fix_r9_{ts}.json")
    shutil.copy2(DATA_PATH, backup_path)
    print(f"ðŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")

    before = Counter(d["label"] for d in data)

    fix_count = 0
    for idx, new_label, new_labels, reason in FIXES:
        sample = data[idx]
        old_label = sample.get("label", "")
        if old_label == new_label:
            continue
        sample["label"] = new_label
        sample["labels"] = new_labels
        sample["note"] = f"Fix R9: {old_label} -> {new_label} ({reason})"
        sample["reviewed_at"] = datetime.now().isoformat()
        sample["reviewed_by"] = "full_audit_r9_feb2026"
        fix_count += 1
        print(f"  âœ… [{idx}] {old_label} -> {new_label}")

    with open(DATA_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    after = Counter(d["label"] for d in data)
    print(f"\nðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯:")
    for k, v in after.most_common():
        diff = v - before.get(k, 0)
        marker = f" ({'+' if diff > 0 else ''}{diff})" if diff != 0 else ""
        print(f"  {k}: {v}{marker}")

    print(f"\nâœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ {fix_count} Ø¹ÙŠÙ†Ø©")


if __name__ == "__main__":
    main()

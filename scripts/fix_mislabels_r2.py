"""
Fix Mislabeled Training Samples - Round 2 (Comprehensive Full Audit)
After reading ALL 2048 samples and verifying each flagged issue.
Creates a backup before applying changes.
"""
import json
import os
import shutil
from datetime import datetime
from collections import Counter

DATA_PATH = "al_rased/data/labeledSamples/training_data.json"
BACKUP_DIR = "al_rased/data/labeledSamples/backups"

# === VERIFIED FIXES (manually reviewed each sample's full text) ===
FIXES = [
    # ========================================================
    # OFFER โ REQUEST (Academic Cheating)
    # These samples use request language like "ูู ูุญู" (who solves?)
    # but were labeled as offer (ุนุฑุถ) instead of request (ุทูุจ)
    # ========================================================
    (8, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ูู ูุญู ูุงุฌุจ ุงุญูุงุก = ุทูุจ"),
    (9, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ููู ุงุญุฏ ูุนุฑู ูุญู ูุงุฌุจุงุช = ุทูุจ"),
    (13, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ูู ูุญู ูุงุฌุจ ุงูููุงูู = ุทูุจ"),
    (45, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ุงูู ูุญู ูุงุฌุจุงุช ูุฑุณู = ุทูุจ"),
    (70, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ูู ูุญู ูุงุฌุจ = ุทูุจ"),
    (75, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ุงุจู ูุงุญุฏ ูุญู ูุงุฌุจุงุช = ุทูุจ"),
    (91, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ูู ูุญู ุงุฎุชุจุงุฑู = ุทูุจ"),
    (100, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ุชุนุฑููู ุญุฏ ูุญู ูุงุฌุจุงุช = ุทูุจ"),
    (111, "ุบุด ุฃูุงุฏููู (ุทูุจ)", ["ุบุด ุฃูุงุฏููู (ุทูุจ)"],
     "ูู ูุญู ูุงุฌุจ ุงุจู ุญุฏ ุซูุฉ = ุทูุจ"),

    # ========================================================
    # VIOLATION โ NORMAL (samples that discuss violations but aren't actually doing it)
    # ========================================================
    (284, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุชุญุฐูุฑ ูู ุญุณุงุจุงุช ููููุฉ - ูุดุฑ ุชูุนูู ูููุณ ุนุฑุถ"),
    (701, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุชุญุฐูุฑ ูู ุงููุตุงุจูู - ูุตูุญุฉ ูููุณ ุนุฑุถ ุงุญุชูุงู"),
    (1698, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุดููู ุนู ุนุฏู ุงููุจูู ุจุณุจุจ ุงูููุงุตู - ุทุจูุนู"),
    (1926, "ุทุจูุนู", ["ุทุจูุนู"],
     "ูุตุงุฆุญ ุนู ููููุฉ ุงูุชุนุงูู ูุน ุนูููุงุช ุงูุงุญุชูุงู - ุชูุนูู"),

    # ========================================================
    # SPAM โ ACADEMIC CHEATING (offering academic services)
    # ========================================================
    (334, "ุบุด ุฃูุงุฏููู (ุนุฑุถ)", ["ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฎุฏูุงุช ุจุญุซูุฉ ูุทูุจุฉ ุงููุงุฌุณุชูุฑ ูุงูุฏูุชูุฑุงู"),
    (864, "ุบุด ุฃูุงุฏููู (ุนุฑุถ)", ["ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ููุงูุดุฉ ูุดุงุฑูุน ุฃูุงุฏูููุฉ"),
    (1849, "ุบุด ุฃูุงุฏููู (ุนุฑุถ)", ["ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฏูุชูุฑ ูุชุฎุตุต ูู ุงูุฃุจุญุงุซ ูุฑุณุงุฆู ุงููุงุฌุณุชูุฑ ูุงูุฏูุชูุฑุงู"),
    (1883, "ุบุด ุฃูุงุฏููู (ุนุฑุถ)", ["ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฏูุชูุฑ ููุฏู ุฎุฏูุงุช ุจุญุซูุฉ ูุฑุณุงุฆู ูุงุฌุณุชูุฑ ูุฏูุชูุฑุงู"),

    # ========================================================
    # SPAM โ MEDICAL FRAUD (selling sick leaves)
    # ========================================================
    (1730, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)"],
     "ุชุถุจู ูู ุณฺฏููู ุจุตุญุชู - ุจูุน ุฃุนุฐุงุฑ ุทุจูุฉ"),

    # ========================================================
    # SPAM โ HACKING (hacking services)
    # ========================================================
    (1891, "ุชูููุฑ (ุนุฑุถ)", ["ุชูููุฑ (ุนุฑุถ)"],
     "ูุงูุฑ ูุนุฑุถ ุฎุฏูุงุช ุงุฎุชุฑุงู"),

    # ========================================================
    # ACADEMIC โ MEDICAL (primary service is medical fraud)
    # ========================================================
    (38, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)", "ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุณูุงููู ูุงุฌุจุงุช ุจุญูุซุงุช - ุงูุฃุนุฐุงุฑ ุงูุทุจูุฉ ูู ุงูุนูุตุฑ ุงูุฃุจุฑุฒ"),
    (115, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)"],
     "ุชูุฌุฒ ูู ุงูุงุนุฐุงุฑ ุงูุทุจูุฉ - ุงุญุชูุงู ุทุจู ุตุฑูุญ"),
    (126, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)", "ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุงุฌุงุฒุฉ ูุฑุถูุฉ + ุญู ูุงุฌุจุงุช - ุงูุฃุนุฐุงุฑ ุงูุทุจูุฉ ุฃููุงู"),
    (376, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)", "ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฃุนุฐุงุฑ ุทุจูุฉ ูู ุตุญุชู + ุญู ูุงุฌุจุงุช - ุทุจู ุฃููุงู"),
    (425, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)", "ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฃุนุฐุงุฑ ุทุจูุฉ ูุธุงู ุตุญุชู + ุจุญูุซุงุช - ุทุจู ุฃููุงู"),
    (1225, "ุงุญุชูุงู ุทุจู (ุนุฑุถ)", ["ุงุญุชูุงู ุทุจู (ุนุฑุถ)", "ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุจุญูุซ ููุดุงุฑูุน + ุงุนุฐุงุฑ ุทุจูู ูู ุตุญุชู - ูุชุนุฏุฏ ููู ุงูุทุจู ุฃุจุฑุฒ"),

    # ========================================================
    # HACKING โ SPAM (selling followers/likes, not hacking)
    # ========================================================
    (883, "ุณุจุงู", ["ุณุจุงู"],
     "ุฒูุงุฏุฉ ูุชุงุจุนูู ูุดุญู ุฃูุนุงุจ - ุณุจุงู ูููุณ ุชูููุฑ"),
    (886, "ุณุจุงู", ["ุณุจุงู"],
     "ุฒูุงุฏุฉ ูุชุงุจุนูู ูุดุญู ุฃูุนุงุจ - ุณุจุงู ูููุณ ุชูููุฑ"),
    (917, "ุณุจุงู", ["ุณุจุงู"],
     "ุฑุดู ูุชุงุจุนูู ุชูุฌุฑุงู ูุงูุณุชูุฑุงู - ุณุจุงู ูููุณ ุชูููุฑ"),
    (922, "ุณุจุงู", ["ุณุจุงู"],
     "ุดุญู ูุฌูู ุชููุฌุฑุงู ูุฑุดู ุงุนุถุงุก - ุณุจุงู ูููุณ ุชูููุฑ"),
    (924, "ุณุจุงู", ["ุณุจุงู"],
     "ุงุดุชุฑุงูุงุช ุจุฑุงูุฌ ุฐูุงุก ุงุตุทูุงุนู - ุณุจุงู ูููุณ ุชูููุฑ"),
    (930, "ุณุจุงู", ["ุณุจุงู"],
     "ุฒูุงุฏุฉ ูุชุงุจุนูู ูุดุญู ุฃูุนุงุจ - ุณุจุงู ูููุณ ุชูููุฑ"),
    (945, "ุณุจุงู", ["ุณุจุงู"],
     "ุฎุฏูุงุช ูุชุฌุฑ ุณุงูุฏูุชุง ุงุดุชุฑุงูุงุช - ุณุจุงู ูููุณ ุชูููุฑ"),
    (1547, "ุณุจุงู", ["ุณุจุงู"],
     "ุฑุดู ูุชุงุจุนูู ุชูู ุชูู - ุณุจุงู ูููุณ ุชูููุฑ"),
    (1548, "ุณุจุงู", ["ุณุจุงู"],
     "ุฑุดู ูุชุงุจุนูู ุงูุณุชูุฑุงู - ุณุจุงู ูููุณ ุชูููุฑ"),

    # ========================================================
    # FINANCIAL SCAMS โ NORMAL (just discussing crypto/trading, not scamming)
    # ========================================================
    (778, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุชุญููู ููู ููุจูุชูููู - ูุญุชูู ุชุญูููู ูููุณ ุงุญุชูุงู"),

    # ========================================================
    # FINANCIAL SCAMS โ SPAM (talking about exchange coupons as normal discussion)
    # ========================================================
    (490, "ุทุจูุนู", ["ุทุจูุนู"],
     "ููุงุด ุนู ูุณุงุฆู ููุตุฉ ุชุฏุงูู - ูุญุงุฏุซุฉ ุทุจูุนูุฉ"),
    (504, "ุทุจูุนู", ["ุทุจูุนู"],
     "ูู ูุณุงุฆู ุจุดุฑูุท ุชุฏุงูู - ุชุนููู ุนุงุฏู"),
    (507, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุดุฑุญ ูุณููุฉ ุชุฏุงูู - ุชุนููู ุนุงุฏู"),
    (517, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุชูุณูุฑ ูุณุงุฆู ุชุดุฌูุน ุงูุชุฏุงูู - ููุงุด ุนุงุฏู"),

    # ========================================================
    # SPAM โ UNETHICAL (pornographic content)
    # ========================================================
    (896, "ุบูุฑ ุฃุฎูุงูู (ุนุฑุถ)", ["ุบูุฑ ุฃุฎูุงูู (ุนุฑุถ)"],
     "XXX HARDCORE - ูุญุชูู ุฅุจุงุญู ูููุณ ูุฌุฑุฏ ุณุจุงู"),

    # ========================================================
    # FINANCIAL โ SPAM (ad for exchange app, not scam)
    # ========================================================
    (908, "ุณุจุงู", ["ุณุจุงู"],
     "ุฅุนูุงู ููุงู ุจุณูุทุฉ ููุณุจ ุงููุงู - ุณุจุงู ุชุณูููู"),

    # ========================================================
    # SPAM โ NORMAL (just asking a question, not spamming)
    # ========================================================
    (1845, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุณุคุงู ุนู ูุดููุฉ ุงูููู ุงูุฌุงูุนุฉ - ุณุคุงู ุทุจูุนู"),
    (1952, "ุทุจูุนู", ["ุทุจูุนู"],
     "ุฑูุงุจุท ูููู ูุทูุงุจ ุงูุชุนููู ุนู ุจุนุฏ - ูุญุชูู ูููุฏ"),

    # ========================================================
    # UNETHICAL โ ACADEMIC (academic services, not unethical)
    # ========================================================
    (429, "ุบุด ุฃูุงุฏููู (ุนุฑุถ)", ["ุบุด ุฃูุงุฏููู (ุนุฑุถ)"],
     "ุฃูุงุฏููููู ุงูุฎููุฌ ุงูุนุฑุจู ูุฎุฏูุงุช ุงูุฏุฑุงุณุงุช ุงูุนููุง"),

    # ========================================================
    # ACADEMIC โ SPAM (offering non-academic digital services)
    # ========================================================
    (311, "ุณุจุงู", ["ุณุจุงู"],
     "ุชุทุจูู ููุชุฌุฑ ุฅููุชุฑููู - ุฎุฏูุงุช ุชูููุฉ ูููุณ ุบุด ุฃูุงุฏููู"),

    # ========================================================
    # NORMAL โ ACADEMIC OFFER (hidden violations in Normal)
    # ========================================================
    # NOTE: samples 1662, 1720, 1724, 1736, 1776, 1844, 1882, 1907, 
    # 1920, 1925, 1928, 1973, 2003, 2026 are correctly NORMAL -
    # just students asking about exams/medical excuses legitimately
]

# ========================================================
# FALSE POSITIVES (kept as-is after careful review):
# ========================================================
# [42] "ุนูุฏู ุงุญุฏ ูุญู" = OFFER (recommending someone, not requesting)
# [55] "ุนูุฏู ูู ูุญู" = OFFER (has someone who solves)
# [147] about a professor - this IS academic cheating offer
# [242] "ุนูุฏู ูุงุญุฏ ูุดุฑุญ" = OFFER (recommending someone)
# [268] "ูู ุชุจุญุซ ุนู ูู ูุญู" = OFFER (marketing academic services)
# [336] "ุนูุฏู ูุงุญุฏ ูุดุฑุญ" = OFFER (recommending)
# [146] helping with homework for a fee - borderline spam/academic, keeping as academic
# [298] academic services ad with subscription - correct as academic
# [327] ุฎุฏูุงุช ุฅููุชุฑูููุฉ - correctly spam (general digital services)
# [405] ููุตุฉ ุงูุนุชูุจู ุงูุชุนููููุฉ - correctly academic (educational platform)
# [1000] ุฎุฏูุงุช ุฅููุชุฑูููุฉ ูููุนูููู ูุงูุทูุงุจ - keeping as academic
# [1004] ุณูุฑูุฑ ูุงูููุฑุงูุช with "ููุฑ" in text - correctly spam (gaming server)
# [1485] ุนุฑูุถ ุญุตุฑูุงุช - keeping as unethical (premium content)
# [1545] ุณูุฑูุฑ ูุตู ููุจ with "ููุฑ" mention - correctly spam (gaming)
# [1580] ููุงูุฏ ูุฑุงูุช Cloud Craft - correctly spam (gaming server)
# [1584-1589] ูุงูุงุช ุจุจุฌู - CORRECTLY HACKING (selling game hacks)
# [1586] ูุชููุฑ ุงุดุชุฑุงูุงุช ูุงูุงุช - CORRECTLY HACKING
# [880] ุงุจูุน ุงูุญุณุงุจ ุงูุฏุงุฆู - keeping as spam (selling account)
# [950, 959, 984] ุฎุฏูุงุช ุชุตููู ููุงูุน - correctly spam (web design services, not academic)
# [996] already fixed in round 1
# [2013] ุงูุชุชุงุญ ุณูุฑูุฑ - keeping as spam (server promotion)


def main():
    print("=" * 60)
    print("๐ง ุฅุตูุงุญ ุงูุนููุงุช ุงูููุณููุฉ ุจุงูุบูุท - ุงูุฌููุฉ ุงูุซุงููุฉ")
    print("=" * 60)

    # Load data
    with open(DATA_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    print(f"๐ ุฅุฌูุงูู ุงูุนููุงุช: {len(data)}")

    # Create backup
    os.makedirs(BACKUP_DIR, exist_ok=True)
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = os.path.join(BACKUP_DIR, f"training_data_pre_fix_r2_{ts}.json")
    shutil.copy2(DATA_PATH, backup_path)
    print(f"๐พ ูุณุฎุฉ ุงุญุชูุงุทูุฉ: {backup_path}")

    # Show before stats
    print("\n๐ ุฅุญุตุงุฆูุงุช ูุจู ุงูุฅุตูุงุญ:")
    before = Counter(d["label"] for d in data)
    for k, v in before.most_common():
        print(f"  {k}: {v}")

    # Apply fixes
    print(f"\n๐ง ุชุทุจูู {len(FIXES)} ุฅุตูุงุญ...")
    print("-" * 60)

    fix_count = 0
    skipped = 0
    for idx, new_label, new_labels, reason in FIXES:
        if idx >= len(data):
            print(f"  โ๏ธ  [{idx}] ุฎุงุฑุฌ ุงููุทุงู (max={len(data)-1})")
            continue

        sample = data[idx]
        old_label = sample.get("label", "")
        old_labels = sample.get("labels", [])

        if old_label == new_label and old_labels == new_labels:
            skipped += 1
            continue

        # Apply fix
        sample["label"] = new_label
        sample["labels"] = new_labels
        sample["note"] = f"Mislabel Fix R2: {old_label} -> {new_label} ({reason})"
        sample["reviewed_at"] = datetime.now().isoformat()
        sample["reviewed_by"] = "full_audit_r2_feb2026"

        fix_count += 1
        text_preview = sample["text"][:50].replace('\n', ' ')
        print(f"  โ [{idx}] {old_label} -> {new_label}")
        print(f"       ุงููุต: {text_preview}...")
        print(f"       ุงูุณุจุจ: {reason}")

    if skipped:
        print(f"\n  โญ๏ธ  ุชุฎุทู {skipped} ุนููุฉ (ุจุงููุนู ุตุญูุญุฉ)")

    # Save
    with open(DATA_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    # Show after stats
    print(f"\n๐ ุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุฅุตูุงุญ:")
    after = Counter(d["label"] for d in data)
    for k, v in after.most_common():
        diff = v - before.get(k, 0)
        marker = f" ({'+' if diff > 0 else ''}{diff})" if diff != 0 else ""
        print(f"  {k}: {v}{marker}")

    print(f"\nโ ุชู ุฅุตูุงุญ {fix_count} ุนููุฉ ุจูุฌุงุญ (ูู {len(FIXES)} ูุทููุจุฉ).")
    print(f"๐พ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูุญููุธุฉ ูู: {backup_path}")


if __name__ == "__main__":
    main()

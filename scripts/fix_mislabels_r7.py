"""
Fix Mislabeled Training Samples - Round 7 (Seventh Full Re-audit)
Automated anomaly detection + manual verification of flagged samples.
"""
import json
import os
import shutil
from datetime import datetime
from collections import Counter

DATA_PATH = "al_rased/data/labeledSamples/training_data.json"
BACKUP_DIR = "al_rased/data/labeledSamples/backups"

FIXES = [
    # ========================================================
    # MEDICAL FRAUD (Ø¹Ø±Ø¶) â†’ NORMAL / Ø·Ù„Ø¨ (student questions about sick leaves)
    # ========================================================
    (1029, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø¨Ø³Ø§Ù„ÙƒÙ… Ù„Ùˆ Ø§Ù†ÙŠ ØºØ§ÙŠØ¨Ù‡ ÙˆØ¬Ø¨Øª Ø³ÙƒÙ„ÙŠÙ Ù…Ù† Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù‡Ù„ÙŠ Ù…Ø§ ÙŠÙ‚Ø¨Ù„ÙˆÙ†Ù‡ = Ø³Ø¤Ø§Ù„"),
    (1033, "Ø§Ø­ØªÙŠØ§Ù„ Ø·Ø¨ÙŠ (Ø·Ù„Ø¨)", ["Ø§Ø­ØªÙŠØ§Ù„ Ø·Ø¨ÙŠ (Ø·Ù„Ø¨)"],
     "Ù…Ù† ÙŠØ³ÙˆÙŠ Ø³ÙƒÙ„ÙŠÙØŸ = Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ ÙˆÙ„ÙŠØ³ Ø¹Ø±Ø¶"),
    (1040, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ØªØ·Ø¨ÙŠÙ‚ Ø§ÙƒØ§Ø¯ÙŠÙ…ÙŠØ§ Ù…Ø¹Ù„Ù‚ Ù…Ø¹Ø§ÙƒÙ…ØŸ = Ø³Ø¤Ø§Ù„ ØªÙ‚Ù†ÙŠ"),
    (1106, "Ø§Ø­ØªÙŠØ§Ù„ Ø·Ø¨ÙŠ (Ø·Ù„Ø¨)", ["Ø§Ø­ØªÙŠØ§Ù„ Ø·Ø¨ÙŠ (Ø·Ù„Ø¨)"],
     "Ø´Ø¨Ø§Ø¨ ØªØ¹Ø±ÙÙˆÙ† Ø§Ø­Ø¯ ÙŠØ¨ÙŠØ¹ Ø³ÙƒÙ„ÙŠÙ Ø«Ù‚Ù‡ØŸ = Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡"),
    (1108, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ø°Ø§ Ø®Ø°ÙŠØª Ø§Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù‡Ù„ ÙŠØ¹ÙŠØ¯ÙˆÙ† Ù„ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± = Ø³Ø¤Ø§Ù„"),
    (1115, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø·Ø¨ÙŠØ¹ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø§Øª = ØªØ¹Ù„ÙŠÙ‚ Ù‚ØµÙŠØ± Ø¹Ø§Ø¯ÙŠ"),
    (1117, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙŠÙ‚Ø¨Ù„ÙˆÙ† Ø³ÙƒÙ„ÙŠÙ Ù…Ù† Ù…Ø³ØªÙˆØµÙØŸ = Ø³Ø¤Ø§Ù„"),
    (1123, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ØªØ¹Ø±ÙÙˆÙ† Ø§ÙŠØ´ Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø§Ù„Ù„ÙŠ ÙŠØ¹Ø·ÙˆÙ† Ø¹Ø°Ø± Ø·Ø¨ÙŠØŸ = Ø³Ø¤Ø§Ù„"),
    (1155, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù„Ùˆ Ø§Ø¬ÙŠØ¨ Ø³ÙƒÙ„ÙŠÙ ÙŠÙ‚Ø¨Ù„ÙˆÙ†Ù‡ØŸ = Ø³Ø¤Ø§Ù„"),

    # ========================================================
    # HACKING (ØªÙ‡ÙƒÙŠØ± Ø¹Ø±Ø¶) â†’ NORMAL (password/login questions)
    # Students asking about Blackboard passwords - NOT hacking
    # ========================================================
    (1535, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ù‚Ø³Ù… Ø¨Ø§Ù„Ù„Ù‡ Ù…Ùˆ Ù…Ù‡ÙƒØ±Ù‡ = Ø¥Ù†ÙƒØ§Ø± Ø§Ù„ØªÙ‡ÙƒÙŠØ±"),
    (1536, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙˆÙ‚ÙˆÙ„ÙˆÙ„ÙŠ Ù‡ÙƒØ±Øª Ø§Ù„Ù…Ø¬Ø§Ù„ = Ø¥Ù†ÙƒØ§Ø± Ø§Ù„ØªÙ‡ÙƒÙŠØ±"),
    (1555, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙˆØ´ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙŠ ÙŠØ¬ÙŠ Ù„Ù…Ø§ Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ù„Ø§Ùƒ Ø¨ÙˆØ±Ø¯ = Ø³Ø¤Ø§Ù„"),
    (1556, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù„ÙŠÙ‡ Ù„Ù…Ù† Ø§Ø¬ÙŠ Ø§ØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙŠØ¬ÙŠÙ†ÙŠ Ø­Ø¯Ø« Ø®Ø·Ø§Ø¡ = Ø³Ø¤Ø§Ù„ ØªÙ‚Ù†ÙŠ"),
    (1557, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙˆØ´ Ù„Ù„Ù…Ø®Ø§Ù„ÙÙ‡ Ø§Ù„Ø­ÙŠÙ† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù‡Ùˆ Ù†ÙØ³Ù‡ Ø§Ù„ÙŠ Ø£Ø­Ø·Ù‡ = Ø³Ø¤Ø§Ù„"),
    (1564, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù‡Ù„ Ø§Ø¬Ø¨Ø§Ø±ÙŠ Ø§ØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆÙ„Ø§ Ø¹Ø§Ø¯ÙŠ Ø§Ø®Ù„ÙŠÙ‡ = Ø³Ø¤Ø§Ù„"),
    (1565, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙˆØ§Ø°Ø§ Ù…Ø§ØºÙŠØ±ØªÙ‡ ÙˆØ´ ÙŠØµÙŠØ± = Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯"),
    (1566, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù…Ù† ÙƒÙ… Ù„ÙƒÙ… Ù…Ø¯Ø© ØªØºÙŠØ±Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ = Ø³Ø¤Ø§Ù„"),

    # ========================================================
    # UNETHICAL â†’ NORMAL (mechanical engineering / clinical pharmacy)
    # ========================================================
    (1510, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø·Ø§Ù„Ø¨ Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ù…ØµØ±ÙŠ ÙŠØ±ÙŠØ¯ Ø¥ÙƒÙ…Ø§Ù„ Ø¯Ø±Ø§Ø³ØªÙ‡ Ø¨Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© = Ø³Ø¤Ø§Ù„"),
    (1511, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ù„ØµÙŠØ¯Ù„Ø© Ø§Ù„Ø§ÙƒÙ„ÙŠÙ†ÙŠÙƒÙŠØ© ÙÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø³Ø¹ÙˆØ¯ = Ø³Ø¤Ø§Ù„ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ"),
    (1706, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ø­Ø¯ Ø¹Ù†Ø¯Ù‡ Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø© = Ø³Ø¤Ø§Ù„ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ"),

    # ========================================================
    # UNETHICAL â†’ ACADEMIC CHEATING (programming help service)
    # ========================================================
    (1513, "ØºØ´ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ (Ø¹Ø±Ø¶)", ["ØºØ´ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ (Ø¹Ø±Ø¶)"],
     "Ø´Ø±ÙˆØ­Ø§Øª Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¨Ø±Ø§Ù…Ø¬ ÙˆØ§Ø¬Ø¨Ø§Øª ÙƒØ§ÙØ© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ = Ø®Ø¯Ù…Ø§Øª Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©"),

    # ========================================================
    # ACADEMIC CHEATING (Ø¹Ø±Ø¶) â†’ NORMAL (student question)
    # ========================================================
    (1709, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ù„Ø¹ÙŠØ§Ù„ Ø§Ù„Ù„ÙŠ Ø¨Ù†ÙØ³ Ø´Ø¹Ø¨ØªÙ†Ø§ ÙŠØ§Ø®Ø°ÙˆÙ† Ù†ÙØ³ Ù…ÙˆØ§Ø¯Ù†Ø§ = Ø³Ø¤Ø§Ù„ Ø¹Ø§Ø¯ÙŠ"),
]


def main():
    print("=" * 60)
    print("ðŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª - Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©")
    print("=" * 60)

    with open(DATA_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    print(f"ðŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª: {len(data)}")

    os.makedirs(BACKUP_DIR, exist_ok=True)
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = os.path.join(BACKUP_DIR, f"training_data_pre_fix_r7_{ts}.json")
    shutil.copy2(DATA_PATH, backup_path)
    print(f"ðŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")

    print("\nðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø¨Ù„:")
    before = Counter(d["label"] for d in data)
    for k, v in before.most_common():
        print(f"  {k}: {v}")

    print(f"\nðŸ”§ ØªØ·Ø¨ÙŠÙ‚ {len(FIXES)} Ø¥ØµÙ„Ø§Ø­...")
    print("-" * 60)

    fix_count = 0
    skipped = 0
    for idx, new_label, new_labels, reason in FIXES:
        if idx >= len(data):
            continue
        sample = data[idx]
        old_label = sample.get("label", "")
        if old_label == new_label and sample.get("labels", []) == new_labels:
            skipped += 1
            continue

        sample["label"] = new_label
        sample["labels"] = new_labels
        sample["note"] = f"Fix R7: {old_label} -> {new_label} ({reason})"
        sample["reviewed_at"] = datetime.now().isoformat()
        sample["reviewed_by"] = "full_audit_r7_feb2026"

        fix_count += 1
        text_preview = sample["text"][:50].replace('\n', ' ')
        print(f"  âœ… [{idx}] {old_label} -> {new_label}")
        print(f"       {text_preview}...")

    if skipped:
        print(f"\n  â­ï¸  ØªØ®Ø·ÙŠ {skipped}")

    with open(DATA_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"\nðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯:")
    after = Counter(d["label"] for d in data)
    for k, v in after.most_common():
        diff = v - before.get(k, 0)
        marker = f" ({'+' if diff > 0 else ''}{diff})" if diff != 0 else ""
        print(f"  {k}: {v}{marker}")

    print(f"\nâœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ {fix_count} Ø¹ÙŠÙ†Ø©")


if __name__ == "__main__":
    main()

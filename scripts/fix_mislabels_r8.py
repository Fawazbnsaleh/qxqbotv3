"""
Fix Mislabeled Training Samples - Round 8 (Eighth Full Re-audit)
Used comprehensive automated anomaly detection with 7 check types.
"""
import json, os, shutil
from datetime import datetime
from collections import Counter

DATA_PATH = "al_rased/data/labeledSamples/training_data.json"
BACKUP_DIR = "al_rased/data/labeledSamples/backups"

FIXES = [
    # ========================================================
    # ØªÙ‡ÙƒÙŠØ± (Ø¹Ø±Ø¶) â†’ Ø·Ø¨ÙŠØ¹ÙŠ (password/Blackboard questions)
    # ========================================================
    (1559, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø£Ø­Ø·Ù‡ Ø§Ù†Ø§ Ø§Ø¯Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†ÙØ§Ø° Ù… Ù‚Ø¯ Ø­Ø³ÙŠØª Ø¨Ø¨Ø§Ø³ÙˆØ±Ø¯ = Ø³Ø¤Ø§Ù„ Ø¯Ø®ÙˆÙ„"),
    (1560, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„ÙŠ ØªØ¯Ø®Ù„ ÙÙŠÙ‡ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ = ØªÙˆØ¶ÙŠØ­"),
    (1561, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙŠØ§Ø¬Ù…Ø§Ø¹Ù‡ Ù„Ø§Ø²Ù… Ù…Ø±Ù‡ Ø£ØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ = Ø³Ø¤Ø§Ù„"),
    (1563, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø·Ø±ÙŠÙ‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ø§ÙˆØ¯Ø³ Ø§Ù„Ø·Ø§Ù„Ø¨ = Ø´Ø±Ø­ Ø¥Ø±Ø´Ø§Ø¯ÙŠ"),
    (1567, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù„Ù…Ø§ ØºÙŠØ±Øª Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø·Ù„Ø¹Ù†ÙŠ Ù…Ù† Ø§ÙŠÙ…ÙŠÙ„ÙŠ Ù…Ùˆ Ø±Ø§Ø¶ÙŠ ÙŠØ¯Ø®Ù„Ù†ÙŠ = Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©"),

    # ========================================================
    # ØºØ´ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ â†’ NORMAL/SPAM (not actual cheating services)
    # ========================================================
    (1640, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ù„Ù„ÙŠ ÙÙŠ Ù…Ø³Ø§Ø± ØµØ­ÙŠ ÙˆØ­Ø§Ø¨Ø¨ Ø¯ÙƒØªÙˆØ± Ù…ØªØ®ØµØµ ÙŠØ±Ø§Ø³Ù„Ù†ÙŠ = ØªÙˆØµÙŠØ© Ø¯Ø±ÙˆØ³ Ø®ØµÙˆØµÙŠØ©"),
    (1648, "Ø³Ø¨Ø§Ù…", ["Ø³Ø¨Ø§Ù…"],
     "ØªØµÙ…ÙŠÙ… Ø¯Ø¹ÙˆØ§Øª ØªØ®Ø±Ø¬ ÙˆØ£Ø¹Ø±Ø§Ø³ ÙˆØ³ÙŠÙÙŠ cv = Ø®Ø¯Ù…Ø§Øª ØªØµÙ…ÙŠÙ…"),
    (1661, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙÙŠ Ù‚Ø±ÙˆØ¨Ø§Øª Ø­Ù‚ Ø§Ù„Ø§Ù†Ø´Ø·Ø© ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ù„Ù„Ø¬Ø§Ù…Ø¹Ø© ÙˆÙ„Ø§ = Ø³Ø¤Ø§Ù„"),
    (1703, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø¨Ù†Øª Ø¬Ø§Øª ØªØ³ØªÙØ³Ø± ÙˆØ§Ù„Ø·ÙŠØ¨ Ø´Ø§Ù†Øª Ø§Ø®Ù„Ø§Ù‚Ù‡ = Ø´ÙƒÙˆÙ‰ Ø¹Ù† Ø³Ù„ÙˆÙƒ"),
    (1714, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„ØªØ±Ù… Ø§Ù„Ø¬Ø§ÙŠ Ø¨ØªØ§Ø®Ø° Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù‚Ø±ÙˆØ¨ Ù„Ù‡Ø§ = Ø³Ø¤Ø§Ù„"),
    (1803, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ù„Ø§ Ù…Ø§ Ø±Ø§Ø­ ØªØ¯Ø®Ù„ Ù…Ø¹Ùƒ Ù„Ø§Ù† Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø²Ù… ØªØ±Ù… Ù„Ø­Ø§Ù„Ù‡Ø§ = Ù†ØµÙŠØ­Ø©"),
    (1905, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ÙÙŠÙ‡ Ø¯ÙˆØ±Ù‡ Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù…Ø¬Ø§Ù†ÙŠÙ‡ ÙˆØ¹Ù„ÙŠÙ‡Ø§ Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¹ØªÙ…Ø¯Ù‡ = Ø¥Ø¹Ù„Ø§Ù† Ø¯ÙˆØ±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©"),

    # ========================================================
    # Unethical â†’ NORMAL (not actually unethical)
    # ========================================================
    (1886, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø­Ø³Ø§Ø¨ Ù…Ø´Ø¨ÙˆÙ‡ Ø¨ÙŠÙ†Ø§Ù†Ø³ OKX ØªÙ‚Ø¯Ø± ØªØ¹Ù…Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª = Ù†ØµÙŠØ­Ø© ÙƒØ±ÙŠØ¨ØªÙˆ"),
    (1903, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "Ø§Ø­Ø¯ ÙŠØ¹Ø±Ù Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø¹Ø¨Ø¯ÙŠ Ù‡Ù„ Ù‡Ù… = Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø£Ø³Ø§ØªØ°Ø©"),
    (2023, "Ø·Ø¨ÙŠØ¹ÙŠ", ["Ø·Ø¨ÙŠØ¹ÙŠ"],
     "ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨Ù„Ø§Ø³ÙŠØ¨Ùˆ Ø­ÙŠÙ† Ù†Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø°Ù†ÙˆØ¨ Ø¨Ø£Ù‚Ø±Ø§Øµ Ø§Ù„ÙˆÙ‡Ù… = Ù…Ù‚Ø§Ù„ Ø¯ÙŠÙ†ÙŠ"),

    # ========================================================
    # ØªÙ‡ÙƒÙŠØ± (Ø¹Ø±Ø¶) â€” FALSE POSITIVES (correctly labeled, keep as-is)
    # [1562] Ø¨Ù„Ø§Øº Ø¹ØµØ§Ø¨Ø© ÙŠÙ…Ù†ÙŠÙŠÙ† Ù‡ÙƒØ± = ØªØ­Ø°ÙŠØ± Ù…Ù† Ù‡Ø§ÙƒØ±Ø² â†’ keep ØªÙ‡ÙƒÙŠØ±
    # [2021] Ø§Ø®ØªØ±Ø§Ù‚ Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠØ³ Ø¨ÙˆÙƒ = actual hacking service â†’ keep ØªÙ‡ÙƒÙŠØ±
    # ========================================================

    # ========================================================
    # Ø§Ø­ØªÙŠØ§Ù„ Ù…Ø§Ù„ÙŠ (Ø¹Ø±Ø¶) â†’ false positive (LinkedIn rental IS a scam)
    # [1937] ØªØ£Ø¬Ø± Ø­Ø³Ø§Ø¨Ùƒ LinkedIn = scam â†’ keep Ø§Ø­ØªÙŠØ§Ù„ Ù…Ø§Ù„ÙŠ
    # ========================================================
]


def main():
    print("=" * 60)
    print("ðŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª - Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù…Ù†Ø©")
    print("=" * 60)

    with open(DATA_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    print(f"ðŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª: {len(data)}")

    os.makedirs(BACKUP_DIR, exist_ok=True)
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = os.path.join(BACKUP_DIR, f"training_data_pre_fix_r8_{ts}.json")
    shutil.copy2(DATA_PATH, backup_path)
    print(f"ðŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_path}")

    print("\nðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø¨Ù„:")
    before = Counter(d["label"] for d in data)
    for k, v in before.most_common():
        print(f"  {k}: {v}")

    print(f"\nðŸ”§ ØªØ·Ø¨ÙŠÙ‚ {len(FIXES)} Ø¥ØµÙ„Ø§Ø­...")
    print("-" * 60)

    fix_count = 0
    skipped = 0
    for idx, new_label, new_labels, reason in FIXES:
        if idx >= len(data):
            continue
        sample = data[idx]
        old_label = sample.get("label", "")
        if old_label == new_label and sample.get("labels", []) == new_labels:
            skipped += 1
            continue

        sample["label"] = new_label
        sample["labels"] = new_labels
        sample["note"] = f"Fix R8: {old_label} -> {new_label} ({reason})"
        sample["reviewed_at"] = datetime.now().isoformat()
        sample["reviewed_by"] = "full_audit_r8_feb2026"

        fix_count += 1
        text_preview = sample["text"][:50].replace('\n', ' ')
        print(f"  âœ… [{idx}] {old_label} -> {new_label}")
        print(f"       {text_preview}...")

    if skipped:
        print(f"\n  â­ï¸  ØªØ®Ø·ÙŠ {skipped}")

    with open(DATA_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"\nðŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¹Ø¯:")
    after = Counter(d["label"] for d in data)
    for k, v in after.most_common():
        diff = v - before.get(k, 0)
        marker = f" ({'+' if diff > 0 else ''}{diff})" if diff != 0 else ""
        print(f"  {k}: {v}{marker}")

    print(f"\nâœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ {fix_count} Ø¹ÙŠÙ†Ø©")


if __name__ == "__main__":
    main()
